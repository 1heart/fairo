

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Controller &mdash; droidlet master documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Memory" href="memory.html" />
    <link rel="prev" title="droidlet" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> droidlet
          

          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Controller</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dialogue-stack-and-manager">Dialogue Stack and Manager</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#semantic-parser">Semantic Parser</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dialogue-objects">Dialogue Objects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#interpreter">Interpreter</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="memory.html">Memory</a><ul>
<li class="toctree-l2"><a class="reference internal" href="memory.html#database">Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="memory.html#memorynodes">MemoryNodes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="perception.html">Perception</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="droidlet_agents.html">Agents</a><ul>
<li class="toctree-l2"><a class="reference internal" href="droidlet_agents.html#locobot">Locobot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="droidlet_agents.html#locobot-perception">Locobot Perception</a><ul>
<li class="toctree-l4"><a class="reference internal" href="droidlet_agents.html#pipelines">Pipelines</a></li>
<li class="toctree-l4"><a class="reference internal" href="droidlet_agents.html#components">Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="droidlet_agents.html#data-structures">Data Structures</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="droidlet_agents.html#locobot-pyrobot-interface">Locobot PyRobot interface</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="droidlet_agents.html#craftassist">Craftassist</a><ul>
<li class="toctree-l3"><a class="reference internal" href="droidlet_agents.html#craftassist-perception">Craftassist Perception</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">droidlet</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Controller</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/controller.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="controller">
<span id="controller-label"></span><h1>Controller<a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h1>
<p>In the “abstract” droidlet agent, the controller chooses whether to put Tasks on the Task Stack based on the memory state.   In the locobot agent and the craftassist agent subclasses, it consists of</p>
<ul class="simple">
<li><p>a <a class="reference external" href="https://github.com/fairinternal/minecraft/blob/master/base_agent/documents/Action_Dictionary_Spec.md">DSL</a></p></li>
<li><p>a neural semantic parser, which translates natural language into partially specified programs over the DSL</p></li>
<li><p>a Dialogue Manager, Dialogue Stack, and Dialogue objects.</p></li>
<li><p>the Intepreter, a special Dialogue Object that takes partially specified programs from the DSL and fully specifies them using the Memory</p></li>
<li><p>a set of “default behaviors”, run randomly when the Task Stack and Dialogue Stack are empty</p></li>
</ul>
<p>Dialogue Objects behave similarly to <a class="reference internal" href="tasks.html#tasks-label"><span class="std std-ref">Tasks</span></a> , except they only affect the agent’s environment directly by causing the agent to issue utterances (or indirectly by pushing Task Objects onto the Task Stack).  In particular, each Dialogue Object has a .step() that is run when it is the highest priority object on the Stack. Dialogue Objects, like Task Objects are modular:  a learned model or a heuristic can mediate the Dialogue Object, and the same model or heuristic script can be used across many different agents.</p>
<p>The Dialogue Manager puts Dialogue Objects on the Dialogue Stack, either on its own, or at the request of a Dialogue Object.  In the locobot and craftassist agent, the manager is powered by a <a class="reference external" href="https://github.com/fairinternal/minecraft/blob/master/base_agent/ttad/">neural semantic parser</a>.</p>
<p>A sketch of the controller’s operation is then</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">new</span> <span class="n">utterance</span> <span class="kn">from</span> <span class="nn">human</span><span class="p">:</span>
     <span class="n">logical_form</span> <span class="o">=</span> <span class="n">semantic_parser</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">new</span> <span class="n">command</span><span class="p">)</span>
     <span class="k">if</span> <span class="n">the</span> <span class="n">logical_form</span> <span class="n">denotes</span> <span class="n">a</span> <span class="n">command</span><span class="p">:</span>
         <span class="n">push</span> <span class="n">Interpreter</span><span class="p">(</span><span class="n">logical_form</span><span class="p">,</span> <span class="n">agent_memory</span><span class="p">)</span> <span class="n">onto</span> <span class="n">the</span> <span class="n">DialogueStack</span>
     <span class="k">else</span> <span class="k">if</span> <span class="n">the</span> <span class="n">logical_form</span> <span class="n">denotes</span> <span class="n">some</span> <span class="n">other</span> <span class="n">kind</span> <span class="n">of</span> <span class="n">dialogue</span> <span class="n">the</span> <span class="n">agent</span> <span class="n">can</span> <span class="n">handle</span><span class="p">:</span>
         <span class="n">push</span> <span class="n">some</span> <span class="n">other</span> <span class="n">appropriate</span> <span class="n">DialogueObject</span> <span class="n">on</span> <span class="n">the</span> <span class="n">DialogueStack</span>
<span class="k">if</span> <span class="n">the</span> <span class="n">Dialogue</span> <span class="n">Stack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">empty</span><span class="p">:</span>
     <span class="n">step</span> <span class="n">the</span> <span class="n">highest</span> <span class="n">priority</span> <span class="n">DialogueObject</span>
<span class="k">if</span> <span class="n">TaskStack</span> <span class="ow">is</span> <span class="n">empty</span><span class="p">:</span>
     <span class="n">maybe</span> <span class="n">place</span> <span class="n">default</span> <span class="n">behaviors</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
</pre></div>
</div>
<div class="section" id="dialogue-stack-and-manager">
<h2>Dialogue Stack and Manager<a class="headerlink" href="#dialogue-stack-and-manager" title="Permalink to this headline">¶</a></h2>
<p>The Dialogue Stack holds Dialogue Objects, and steps them.</p>
<blockquote>
<div><dl class="py class">
<dt id="base_agent.dialogue_stack.DialogueStack">
<em class="property">class </em><code class="sig-prename descclassname">base_agent.dialogue_stack.</code><code class="sig-name descname">DialogueStack</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">agent</span></em>, <em class="sig-param"><span class="n">memory</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_stack.html#DialogueStack"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_stack.DialogueStack" title="Permalink to this definition">¶</a></dt>
<dd><p>This class organizes and steps DialogueObjects.</p>
<dl class="py method">
<dt id="base_agent.dialogue_stack.DialogueStack.append">
<code class="sig-name descname">append</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">dialogue_object</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_stack.html#DialogueStack.append"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_stack.DialogueStack.append" title="Permalink to this definition">¶</a></dt>
<dd><p>Append a dialogue_object to stack</p>
</dd></dl>

<dl class="py method">
<dt id="base_agent.dialogue_stack.DialogueStack.clear">
<code class="sig-name descname">clear</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_stack.html#DialogueStack.clear"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_stack.DialogueStack.clear" title="Permalink to this definition">¶</a></dt>
<dd><p>clear current stack</p>
</dd></dl>

<dl class="py method">
<dt id="base_agent.dialogue_stack.DialogueStack.peek">
<code class="sig-name descname">peek</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_stack.html#DialogueStack.peek"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_stack.DialogueStack.peek" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the item on top of the DialogueStack</p>
</dd></dl>

<dl class="py method">
<dt id="base_agent.dialogue_stack.DialogueStack.step">
<code class="sig-name descname">step</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_stack.html#DialogueStack.step"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_stack.DialogueStack.step" title="Permalink to this definition">¶</a></dt>
<dd><p>Process and step through the top-of-stack dialogue object.</p>
</dd></dl>

</dd></dl>

</div></blockquote>
<p>The Dialogue Manager operates the Stack, and chooses whether to place Dialogue objects</p>
<blockquote>
<div><dl class="py class">
<dt id="base_agent.nsp_dialogue_manager.NSPDialogueManager">
<em class="property">class </em><code class="sig-prename descclassname">base_agent.nsp_dialogue_manager.</code><code class="sig-name descname">NSPDialogueManager</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">agent</span></em>, <em class="sig-param"><span class="n">dialogue_object_classes</span></em>, <em class="sig-param"><span class="n">opts</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/nsp_dialogue_manager.html#NSPDialogueManager"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.nsp_dialogue_manager.NSPDialogueManager" title="Permalink to this definition">¶</a></dt>
<dd><p>Dialogue manager driven by neural network.</p>
<dl class="field-list simple">
<dt class="field-odd">Variables</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>~NSPDialogueManager.dialogue_objects</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.9)"><em>dict</em></a>) – Dictionary specifying the DialogueObject
class for each dialogue type. Keys are dialogue types. Values are
corresponding class names. Example dialogue objects:
{‘interpreter’: MCInterpreter,
‘get_memory’: GetMemoryHandler,
‘put_memory’: …
}</p></li>
<li><p><strong>~NSPDialogueManager.safety_words</strong> (<em>List</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)"><em>str</em></a><em>]</em>) – Set of blacklisted words or phrases. Commands
containing these are automatically filtered out.</p></li>
<li><p><strong>~NSPDialogueManager.botGreetings</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.9)"><em>dict</em></a>) – Different types of greetings that trigger
scripted responses. Example:
{ “hello”: [“hi bot”, “hello”] }</p></li>
<li><p><strong>~NSPDialogueManager.model</strong> (<a class="reference internal" href="#base_agent.ttad.ttad_transformer_model.query_model.TTADBertModel" title="base_agent.ttad.ttad_transformer_model.query_model.TTADBertModel"><em>TTADBertModel</em></a>) – Semantic Parsing model that takes text as
input and outputs a logical form.
To use a new model here, ensure that the subfolder directory structure
mirrors the current model/dataset directories.
See <code class="xref py py-class docutils literal notranslate"><span class="pre">TTADBertModel</span></code>.</p></li>
<li><p><strong>~NSPDialogueManager.ground_truth_actions</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.9)"><em>dict</em></a>) – A key-value with ground truth logical forms.
These will be queried first (via exact string match), before running the model.</p></li>
<li><p><strong>~NSPDialogueManager.dialogue_object_parameters</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.9)"><em>dict</em></a>) – Set the parameters for dialogue objects.
Sets the agent, memory and dialogue stack.</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>agent</strong> – a droidlet agent, eg. <code class="docutils literal notranslate"><span class="pre">CraftAssistAgent</span></code></p></li>
<li><p><strong>dialogue_object_classes</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.9)"><em>dict</em></a>) – Dictionary specifying the DialogueObject
class for each dialogue type. See <code class="docutils literal notranslate"><span class="pre">dialogue_objects</span></code> definition above.</p></li>
<li><p><strong>opts</strong> (<a class="reference external" href="https://docs.python.org/3/library/argparse.html#argparse.Namespace" title="(in Python v3.9)"><em>argparse.Namespace</em></a>) – <p>Parsed command line arguments specifying parameters in agent.</p>
<dl class="field-list simple">
<dt class="field-odd">param –nsp_models_dir</dt>
<dd class="field-odd"><p>Path to directory containing all files necessary to
load and run the model, including args, tree mappings and the checkpointed model.
Semantic parsing models used by current project are in <code class="docutils literal notranslate"><span class="pre">ttad_bert_updated</span></code>.
eg. semantic parsing model is <code class="docutils literal notranslate"><span class="pre">ttad_bert_updated/caip_test_model.pth</span></code></p>
</dd>
<dt class="field-even">param –nsp_data_dir</dt>
<dd class="field-even"><p>Path to directory containing all datasets used by the NSP model.
Note that this data is not used in inference, rather we load from the ground truth
data directory.</p>
</dd>
<dt class="field-odd">param –ground_truth_data_dir</dt>
<dd class="field-odd"><p>Path to directory containing ground truth datasets
loaded by agent at runtime. Option to include a file for blacklisted words <code class="docutils literal notranslate"><span class="pre">safety.txt</span></code>,
a class for greetings <code class="docutils literal notranslate"><span class="pre">greetings.json</span></code> and .txt files with text, logical_form pairs in
<code class="docutils literal notranslate"><span class="pre">datasets/</span></code>.</p>
</dd>
</dl>
<p>See <code class="xref py py-class docutils literal notranslate"><span class="pre">ArgumentParser</span></code> for full list of command line options.</p>
</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt id="base_agent.nsp_dialogue_manager.NSPDialogueManager.get_logical_form">
<code class="sig-name descname">get_logical_form</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">s</span><span class="p">:</span> <span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a></span></em>, <em class="sig-param"><span class="n">model</span></em>, <em class="sig-param"><span class="n">chat_as_list</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span> &#x2192; Dict<a class="reference internal" href="_modules/base_agent/nsp_dialogue_manager.html#NSPDialogueManager.get_logical_form"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.nsp_dialogue_manager.NSPDialogueManager.get_logical_form" title="Permalink to this definition">¶</a></dt>
<dd><p>Get logical form output for a given chat command.
First check the ground truth file for the chat string. If not
in ground truth, query semantic parsing model to get the output.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>s</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)"><em>str</em></a>) – Input chat provided by the user.</p></li>
<li><p><strong>model</strong> (<a class="reference internal" href="#base_agent.ttad.ttad_transformer_model.query_model.TTADBertModel" title="base_agent.ttad.ttad_transformer_model.query_model.TTADBertModel"><em>TTADBertModel</em></a>) – Semantic parsing model, pre-trained and loaded
by agent</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><dl class="simple">
<dt>Logical form representation of the task. See paper for more</dt><dd><p>in depth explanation of logical forms:
<a class="reference external" href="https://arxiv.org/abs/1907.08584">https://arxiv.org/abs/1907.08584</a></p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>Dict</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">get_logical_form</span><span class="p">(</span><span class="s2">&quot;destroy this&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="go">{</span>
<span class="go">    &quot;dialogue_type&quot;: &quot;HUMAN_GIVE_COMMAND&quot;,</span>
<span class="go">    &quot;action_sequence&quot;: [{</span>
<span class="go">        &quot;action_type&quot;: &quot;DESTROY&quot;,</span>
<span class="go">        &quot;reference_object&quot;: {</span>
<span class="go">            &quot;filters&quot;: {&quot;contains_coreference&quot;: &quot;yes&quot;},</span>
<span class="go">            &quot;text_span&quot;: [0, [1, 1]]</span>
<span class="go">        }</span>
<span class="go">    }]</span>
<span class="go">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt id="base_agent.nsp_dialogue_manager.NSPDialogueManager.handle_logical_form">
<code class="sig-name descname">handle_logical_form</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">speaker</span><span class="p">:</span> <span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a></span></em>, <em class="sig-param"><span class="n">d</span><span class="p">:</span> <span class="n">Dict</span></em>, <em class="sig-param"><span class="n">chatstr</span><span class="p">:</span> <span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a></span></em><span class="sig-paren">)</span> &#x2192; Optional<span class="p">[</span>dialogue_object.DialogueObject<span class="p">]</span><a class="reference internal" href="_modules/base_agent/nsp_dialogue_manager.html#NSPDialogueManager.handle_logical_form"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.nsp_dialogue_manager.NSPDialogueManager.handle_logical_form" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the appropriate DialogueObject to handle an action dict d
d should have spans filled (via process_spans).</p>
</dd></dl>

<dl class="py method">
<dt id="base_agent.nsp_dialogue_manager.NSPDialogueManager.maybe_get_dialogue_obj">
<code class="sig-name descname">maybe_get_dialogue_obj</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">chat</span><span class="p">:</span> <span class="n">Tuple<span class="p">[</span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">, </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a><span class="p">]</span></span></em><span class="sig-paren">)</span> &#x2192; Optional<span class="p">[</span>dialogue_object.DialogueObject<span class="p">]</span><a class="reference internal" href="_modules/base_agent/nsp_dialogue_manager.html#NSPDialogueManager.maybe_get_dialogue_obj"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.nsp_dialogue_manager.NSPDialogueManager.maybe_get_dialogue_obj" title="Permalink to this definition">¶</a></dt>
<dd><p>Process a chat and maybe modify the dialogue stack.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>chat</strong> (<em>Tuple</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)"><em>str</em></a><em>, </em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)"><em>str</em></a><em>]</em>) – Incoming chat from a player.
Format is (speaker, chat), eg. (“player1”, “build a red house”)</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>DialogueObject or empty if no action is needed.</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div></blockquote>
<div class="section" id="semantic-parser">
<h3>Semantic Parser<a class="headerlink" href="#semantic-parser" title="Permalink to this headline">¶</a></h3>
<p>The training of the semantic parsing model we use is described in detail <a class="reference external" href="https://github.com/fairinternal/minecraft/tree/master/base_agent/ttad/">here</a>; the interface is</p>
<blockquote>
<div><dl class="py class">
<dt id="base_agent.ttad.ttad_transformer_model.query_model.TTADBertModel">
<em class="property">class </em><code class="sig-prename descclassname">base_agent.ttad.ttad_transformer_model.query_model.</code><code class="sig-name descname">TTADBertModel</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">model_dir</span></em>, <em class="sig-param"><span class="n">data_dir</span></em>, <em class="sig-param"><span class="n">model_name</span><span class="o">=</span><span class="default_value">'caip_test_model'</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/ttad/ttad_transformer_model/query_model.html#TTADBertModel"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.ttad.ttad_transformer_model.query_model.TTADBertModel" title="Permalink to this definition">¶</a></dt>
<dd><p>TTAD model class that loads a pretrained model and runs inference in the agent.</p>
<dl class="field-list simple">
<dt class="field-odd">Variables</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>~TTADBertModel.tokenizer</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)"><em>str</em></a>) – Pretrained tokenizer used to tokenize input. Runs end-to-end
tokenization, eg. split punctuation, BPE.</p></li>
<li><p><strong>~TTADBertModel.dataset</strong> (<em>CAIPDataset</em>) – CAIP (CraftAssist Instruction Parsing) Dataset. Note that
this is empty during inference.</p></li>
<li><p><strong>~TTADBertModel.encoder_decoder</strong> (<em>EncoderDecoderWithLoss</em>) – Transformer model class. See</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>model_dir</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)"><em>str</em></a>) – Path to directory containing all files necessary to
load and run the model, including args, tree mappings and the checkpointed model.
Semantic parsing models used by current project are in <code class="docutils literal notranslate"><span class="pre">ttad_bert_updated</span></code>.
eg. semantic parsing model is <code class="docutils literal notranslate"><span class="pre">ttad_bert_updated/caip_test_model.pth</span></code></p></li>
<li><p><strong>data_dir</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)"><em>str</em></a>) – Path to directory containing all datasets used by the NSP model.
Note that this data is not used in inference, rather we load from the ground truth
data directory.</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt id="base_agent.ttad.ttad_transformer_model.query_model.TTADBertModel.parse">
<code class="sig-name descname">parse</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">chat</span></em>, <em class="sig-param"><span class="n">noop_thres</span><span class="o">=</span><span class="default_value">0.95</span></em>, <em class="sig-param"><span class="n">beam_size</span><span class="o">=</span><span class="default_value">5</span></em>, <em class="sig-param"><span class="n">well_formed_pen</span><span class="o">=</span><span class="default_value">100.0</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/ttad/ttad_transformer_model/query_model.html#TTADBertModel.parse"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.ttad.ttad_transformer_model.query_model.TTADBertModel.parse" title="Permalink to this definition">¶</a></dt>
<dd><p>Given an incoming chat, query the parser and return a logical form.
Uses beam search decoding, see <code class="xref any docutils literal notranslate"><span class="pre">beam_search</span></code></p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>chat</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)"><em>str</em></a>) – Preprocessed chat command from a player. Used as text input to parser.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Logical form.</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.9)">dict</a></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div></blockquote>
</div>
</div>
<div class="section" id="dialogue-objects">
<h2>Dialogue Objects<a class="headerlink" href="#dialogue-objects" title="Permalink to this headline">¶</a></h2>
<p>The generic Dialogue Object is</p>
<blockquote>
<div><dl class="py class">
<dt id="base_agent.dialogue_objects.dialogue_object.DialogueObject">
<em class="property">class </em><code class="sig-prename descclassname">base_agent.dialogue_objects.dialogue_object.</code><code class="sig-name descname">DialogueObject</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">agent</span></em>, <em class="sig-param"><span class="n">memory</span></em>, <em class="sig-param"><span class="n">dialogue_stack</span></em>, <em class="sig-param"><span class="n">max_steps</span><span class="o">=</span><span class="default_value">50</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_objects/dialogue_object.html#DialogueObject"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_objects.dialogue_object.DialogueObject" title="Permalink to this definition">¶</a></dt>
<dd><p>DialogueObject class controls the agent’s use of the dialogue stack.</p>
<blockquote>
<div><dl class="simple">
<dt>Args:</dt><dd><p>agent: the agent process
memory: agent’s memory
dialogue_stack : A stack on which dialogue objects are placed
finished: whether this object has finished processing
awaiting_response: whether this object is awaiting the speakers response to a question
max_steps: finish after this many steps to avoid getting stuck
current_step: current step count
progeny_data: data from progeny DialogueObjects, for example used to answer a clarification</p>
</dd>
</dl>
<p>Usage:</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DummyGetMemoryHandler</span><span class="p">(</span><span class="n">DialogueObject</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speaker_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># initialize everything</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speaker_name</span> <span class="o">=</span> <span class="n">speaker_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_dict</span> <span class="o">=</span> <span class="n">action_dict</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="c1"># check for dialogue type &quot;GET_MEMORY&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_dict</span><span class="p">[</span><span class="s2">&quot;dialogue_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GET_MEMORY&quot;</span>
        <span class="n">memory_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_dict</span><span class="p">[</span><span class="s2">&quot;filters&quot;</span><span class="p">][</span><span class="s2">&quot;memory_type&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">memory_type</span> <span class="o">==</span> <span class="s2">&quot;AGENT&quot;</span> <span class="ow">or</span> <span class="n">memory_type</span> <span class="o">==</span> <span class="s2">&quot;REFERENCE_OBJECT&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_reference_object</span><span class="p">()</span> <span class="c1"># handle these two by writing them to memory</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown memory_type=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory_type</span><span class="p">))</span>
        <span class="c1"># mark as finished</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<dl class="py method">
<dt id="base_agent.dialogue_objects.dialogue_object.DialogueObject.check_finished">
<code class="sig-name descname">check_finished</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_objects/dialogue_object.html#DialogueObject.check_finished"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_objects.dialogue_object.DialogueObject.check_finished" title="Permalink to this definition">¶</a></dt>
<dd><p>Check if the object is finished processing.</p>
</dd></dl>

<dl class="py method">
<dt id="base_agent.dialogue_objects.dialogue_object.DialogueObject.step">
<code class="sig-name descname">step</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_objects/dialogue_object.html#DialogueObject.step"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_objects.dialogue_object.DialogueObject.step" title="Permalink to this definition">¶</a></dt>
<dd><p>the Dialogue Stack runs this objects .step();</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>string to be uttered by the agent (or None)
progeny_data: data for the parent of this object (or None)</p>
</dd>
<dt class="field-even">Return type</dt>
<dd class="field-even"><p>chat</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div></blockquote>
<p>A DialogueObject’s main method is .step(),
Some others:</p>
<blockquote>
<div><dl class="py class">
<dt id="base_agent.dialogue_objects.dialogue_object.Say">
<em class="property">class </em><code class="sig-prename descclassname">base_agent.dialogue_objects.dialogue_object.</code><code class="sig-name descname">Say</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">response_options</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_objects/dialogue_object.html#Say"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_objects.dialogue_object.Say" title="Permalink to this definition">¶</a></dt>
<dd><p>This class represents a sub-type of DialogueObject to say / send a chat
to the user.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>response_options</strong> – a list of responses to pick the final response from</p>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt id="base_agent.dialogue_objects.dialogue_object.AwaitResponse">
<em class="property">class </em><code class="sig-prename descclassname">base_agent.dialogue_objects.dialogue_object.</code><code class="sig-name descname">AwaitResponse</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">wait_time</span><span class="o">=</span><span class="default_value">800</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_objects/dialogue_object.html#AwaitResponse"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_objects.dialogue_object.AwaitResponse" title="Permalink to this definition">¶</a></dt>
<dd><p>This class represents a sub-type of DialogueObject to await
a response from the user.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>init_time</strong> – initial time</p></li>
<li><p><strong>response</strong> – the response to the question asked</p></li>
<li><p><strong>wait_time</strong> – how long should we await the response</p></li>
<li><p><strong>awaiting_response</strong> – a flag to mark where we are awaiting the response</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt id="base_agent.dialogue_objects.dialogue_object.BotStackStatus">
<em class="property">class </em><code class="sig-prename descclassname">base_agent.dialogue_objects.dialogue_object.</code><code class="sig-name descname">BotStackStatus</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_objects/dialogue_object.html#BotStackStatus"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_objects.dialogue_object.BotStackStatus" title="Permalink to this definition">¶</a></dt>
<dd><p>This class represents a sub-type of the DialogueObject to answer
questions about the current status of the bot, to the user.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>ing_mapping</strong> – A map from task name to present continuous tense language.</p>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt id="base_agent.dialogue_objects.dialogue_object.ConfirmTask">
<em class="property">class </em><code class="sig-prename descclassname">base_agent.dialogue_objects.dialogue_object.</code><code class="sig-name descname">ConfirmTask</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">question</span></em>, <em class="sig-param"><span class="n">tasks</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_objects/dialogue_object.html#ConfirmTask"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_objects.dialogue_object.ConfirmTask" title="Permalink to this definition">¶</a></dt>
<dd><p>This class represents a sub-type of the DialogueObject to ask a clarification
question about something.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>question</strong> – the question to ask the user</p></li>
<li><p><strong>tasks</strong> – list of task objects</p></li>
<li><p><strong>asked</strong> – flag to denote whether the clarification has been asked for</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt id="base_agent.dialogue_objects.dialogue_object.ConfirmReferenceObject">
<em class="property">class </em><code class="sig-prename descclassname">base_agent.dialogue_objects.dialogue_object.</code><code class="sig-name descname">ConfirmReferenceObject</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">reference_object</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_objects/dialogue_object.html#ConfirmReferenceObject"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_objects.dialogue_object.ConfirmReferenceObject" title="Permalink to this definition">¶</a></dt>
<dd><p>This class represents a sub-type of the DialogueObject to confirm if the
reference object is correct.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>bounds</strong> – general area of reference object to point at</p></li>
<li><p><strong>pointed</strong> – flag determining whether the agent pointed at the area</p></li>
<li><p><strong>asked</strong> – flag determining whether the confirmation was asked for</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</div></blockquote>
<div class="section" id="interpreter">
<h3>Interpreter<a class="headerlink" href="#interpreter" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://github.com/fairinternal/minecraft/blob/master/base_agent/dialogue_objects/intepreter.py">Interpreter</a> is responsible for using the world state (via <a class="reference internal" href="memory.html"><span class="doc">memory</span></a>) and a natural language utterance that has been parsed into a logical form over the agent’s DSL from the semantic parser to choose a <a class="reference internal" href="memory.html"><span class="doc">Task</span></a> to put on the Task Stack.   The <a class="reference external" href="https://github.com/fairinternal/minecraft/blob/master/locobot/agent/dialogue_objects/loco_intepreter.py">locobot</a> and <a class="reference external" href="https://github.com/fairinternal/minecraft/blob/master/craftassist/agent/dialogue_objects/mc_intepreter.py">craftassist</a> Interpreters are not the same, but the bulk of the work is done by the shared subinterpreters (in the files *_helper.py) <a class="reference external" href="https://github.com/fairinternal/minecraft/blob/master/base_agent/dialogue_objects/">here</a>.  The subinterpreters, registered in the main Interpreter <a class="reference external" href="https://github.com/fairinternal/minecraft/blob/master/base_agent/dialogue_objects/intepreter.py#L55">here</a> (and for the specialized versions <a class="reference external" href="https://github.com/fairinternal/minecraft/blob/master/locobot/agent/dialogue_objects/loco_intepreter.py#L56">here</a> and <a class="reference external" href="https://github.com/fairinternal/minecraft/blob/master/craftassist/agent/dialogue_objects/mc_intepreter.py#L61">here</a>), roughly follow the structure of the DSL.  This arrangement is to allow replacing the (currently heuristic) subinterpreters with learned versions or specializing them to new agents.</p>
<blockquote>
<div><dl class="py class">
<dt id="base_agent.dialogue_objects.interpreter.Interpreter">
<em class="property">class </em><code class="sig-prename descclassname">base_agent.dialogue_objects.interpreter.</code><code class="sig-name descname">Interpreter</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">speaker</span><span class="p">:</span> <span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)">str</a></span></em>, <em class="sig-param"><span class="n">action_dict</span><span class="p">:</span> <span class="n">Dict</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/base_agent/dialogue_objects/interpreter.html#Interpreter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#base_agent.dialogue_objects.interpreter.Interpreter" title="Permalink to this definition">¶</a></dt>
<dd><div class="line-block">
<div class="line">This class processes incoming chats and modifies the task stack.</div>
<div class="line">Handlers should add/remove/reorder tasks on the stack, but not execute them.</div>
<div class="line">Most of the logic of the interpreter is run in the subinterpreters or task handlers.</div>
<div class="line">The keyword args in __init__ match the base DialogueObject class</div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>speaker</strong> – The name of the player/human/agent who uttered the chat resulting in this interpreter</p></li>
<li><p><strong>action_dict</strong> – The logical form, e.g. returned by a semantic parser</p></li>
</ul>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>agent</strong> – the agent running this Interpreter</p></li>
<li><p><strong>memory</strong> – the agent’s memory</p></li>
<li><p><strong>dialogue_stack</strong> – a DialogueStack object where this Interpreter object will live</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</div></blockquote>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="memory.html" class="btn btn-neutral float-right" title="Memory" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="droidlet" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Facebook AI.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>