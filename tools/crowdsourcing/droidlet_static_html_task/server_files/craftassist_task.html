<!-- Bootstrap v3.0.3 -->
<link
  rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<!-- Modal --><!-- MODAL -->

<div
  aria-hidden="true"
  aria-labelledby="exampleModalLabel"
  class="modal fade in"
  id="exampleModal"
  role="dialog"
  tabindex="-1"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button
          aria-label="Close"
          class="close"
          data-dismiss="modal"
          type="button"
        >
          <span aria-hidden="true"> &times; </span>
        </button>
      </div>

      <div class="modal-body" id="modal">&nbsp;</div>

      <div class="modal-footer">
        <button class="btn btn-primary" id="close-instructions-btn" onclick="recordReadTime()" data-dismiss="modal" type="button" style="display:none">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Content -->

<section
  class="container"
  id="Other"
  style="
    margin-bottom: 15px;
    padding: 10px;
    font-family: Verdana, Geneva, sans-serif;
    font-size: 0.9em;
  "
>
  <div class="row col-xs-12 col-md-12">
    <!-- Instructions -->
    <div class="panel panel-primary">
      <div class="panel-heading">
        <button class="btn btn-primary" type="button" onclick="showHideInstructions()" data-toggle="collapse" data-target="#instructionsWrapper" aria-expanded="false" aria-controls="instructionsWrapper">
          Click here to view/hide instructions
        </button>
      </div>
      <div class="panel-body" id="instructions">
        <p>
            <h1><strong>Interact with an assistant in a 3-D world creative game.</strong></h1>            
            <img src="https://craftassist.s3-us-west-2.amazonaws.com/pubr/voxel_world_agent.png" width="320" height="240">
            <img src="https://craftassist.s3-us-west-2.amazonaws.com/pubr/voxel_2.png" width="320" height="240">
            <img src="https://craftassist.s3-us-west-2.amazonaws.com/pubr/voxel_3.png" width="320" height="240">
            
            <p><b>Imagine you are playing a creative game in a 3-D voxel world and you have access to an assistant (as shown in some screenshots above) that can help you get things done.</b><br />
            <b>Use your imagination and creativity to interact with the assistant. In the setup here, you will be logged in to the voxel world along with the assistant.</b> You can control your position in the 3-D world by clicking on the bottom-left pane and then using the navigation buttons.<br />
            </p>
          
            <p><b style="color: red;">
              IMPORTANT - Please note that you will only get paid if you:
              <ol>
                <li>Click "Start" in the bottom right to begin session.</li>
                <li>Interact with the assistant for the <i>full 5 minutes.</i></li>
                <li>Click on "End" in the bottom right.</li>
                <li>Rate the clarity and usability of the HIT.</li>
                <li>Click on "Submit" button at the bottom.</li>
              </ol>
              Please read these instructions carefully!  You should spend 3 minutes reading and understanding.
            </b></p>
          </div>

            <h5><b style="color:#FF0000;">IMPORTANT: You must click "start" and "end" session in the bottom right pane for your interactions to be recorded!
            
              Please note that you will only get paid if you:
              <p> 1. Click "start" in the bottom right to begin session. Interact with the bot for full 5 minutes. </p> 
              <img src="https://craftassist.s3-us-west-2.amazonaws.com/pubr/click_start_instruction.png" width="320" height="280">
              <p> 2. Once you are done interacting, click on "end" in the bottom right. </p> 
              <img src="https://craftassist.s3-us-west-2.amazonaws.com/pubr/click_finish_instruction.png" width="320" height="280">
              <p> 3. Click on "Submit" button at the bottom. </p> 
            
            </b></h5>

            <h3>How to enter voxel world and control</h3>
            <p>Please click on the upper right pane to enter the 3-D voxel world.<br />
            <b>Please use ‘w/a/s/d’ to move ‘forward/left/back/right’ , ‘space’ to jump and ‘esc’ to leave the world and back to the website.</b><br /></p>
            
            
            <h3>Interacting with the assistant</h3>
            <p>Please use the <b>chat box in the top left pane</b> to speak with and instruct the assistant. <br />
            <p>We ask that you interact with the agent for <b>at least 5 minutes.</b></p> 
            <b>Press “submit” when you are ready to send the command to the assistant</b>. Once you send the command, you should be able to see the assistant execute the command in the 3-D world on bottom-left. The assistant might also send you replies once in a while and you can see that below the “Submit” button. <br />
            <b>The bot might be slow to respond due to network lag. You may expect a few seconds between sending a command and getting responses from the agent (we are improving it!).Please be patient and do not send multiple commands at a time</b>
            
            <p>On the bottom left you will be able to see a history of the last 5 commands you’ve sent to the assistant in the game. </p>
            <b>Keep in mind that the bot is non-violent. </b></p>
            <p>&nbsp;</p>
            
            <b>You can assume that the bot has the following capabilities:</b>
            <ul>
                <li><b>Move</b> (the bot can be told to move around to places, objects, things etc)</li>
                <li><b>Build</b> (the bot can be told to build things)</li>
                <li><b>Destroy</b> (the bot can be told to destroy things)</li>
                <li><b>Dance</b> (the bot can be told to do a movement of some kind)</li>
                <li><b>Get</b> (the bot can be told to get things from one place to another)</li>
                <li><b>Tag</b> (the bot can be told to tag things)</li>
                <li><b>Dig</b> (the bot can be told to dig up things)</li>
                <li><b>Copy</b> (the bot can be told to make a copy of things)</li>
                <li><b>Undo</b> (the bot can be told to revert things)</li>
                <li><b>Fill</b> (the bot can be told to fill up structures)</li>
                <li><b>Spawn</b> (the bot can be told to spawn objects)</li>
                <li><b>Answer</b> (the bot can be told to answer your questions)</li>
                <li><b>Stop</b> (the bot can be told to stop)</li>
                <li><b>Resume</b> (the bot can be told to resume an earlier action)</li>
            </ul>
            <br />
            <p><b>You can talk to the bot as you would to another human player to instruct it to perform actions mentioned above, ask it questions, or to give it information.</b></p><br />
            
            <h3> Mark Errors </h3>
            <p>If the agent fails to do something you asked, please mark the failure! <br />
            <p>This is done by clicking the <b style="color:#FF0000;">MARK ERROR</b> button next to the command. </p> 
            <img src="https://craftassist.s3-us-west-2.amazonaws.com/pubr/mark_errors_big_button.png" width="640" height="570">
            <p>If the agent fails, you will be prompted for more information.</p> 

            <b>Please use your imagination to come up with things you'd like to say to the bot to make the interaction rich, given the bot’s capabilities. Be as creative as you can.</b> </br>
            <b>The instructions should be related to the bot's capabilities, please give us as much variety as you can.</b><br />
            <b>Remember that the bot is non-violent. Please click on the start button when you are ready and once finished, click on the “end” button to proceed to next steps.</b>
            <p><strong><span style="color:#FF0000;">Rejection policy: You HIT will be rejected if any of these are violated</span></strong></p>
            
            <ul>
              <li>The submitted instructions should be valid English sentences.</li>
              <li>The submitted instructions should only be about the bot's capabilities.</li>
              <li>Please be as creative as you can.</li>
              <li>Do not leave an instruction blank.</li>
              <li>All three instructions should be unique.</li>
              <li>Do not use the exact same strategies across HITs.</li>
            </ul>            
        </p>
      </div>
    </div>
    <!-- End Instructions -->
    <!-- Content Body -->
    <!-- End Content Body -->
  </div>
</section>

<section
  class="container"
  id="Other"
  style="
    margin-bottom: 15px;
    padding: 10px;
    font-family: Verdana, Geneva, sans-serif;
    font-size: 0.9em;
    height: 1000px;
  "
>
  <div class="row">
    <!-- Commands Reminder -->
    <div class="col-xs-2">
      <div class="panel panel-primary" style="height:1000px;">
        <div class="panel-heading">
          <strong>Assistant Capabilities</strong>
        </div>
        <p>
          <ul>
            <li><b>Move</b> (to a place or structure)</li>
            <li><b>Build</b> (a shape or structure)</li>
            <li><b>Destroy</b> (a structure)</li>
            <li><b>Dance</b></li>
            <li><b>Get</b> (an object)</li>
            <li><b>Tag</b> (rename something)</li>
            <li><b>Dig</b></li>
            <li><b>Copy</b> (make a copy of an object)</li>
            <li><b>Undo</b></li>
            <li><b>Fill</b> (up a hole or structure)</li>
            <li><b>Spawn</b> (create an animal)</li>
            <li><b>Answer</b> (a question)</li>
            <li><b>Stop</b> </li>
            <li><b>Resume</b> (an earlier action)</li>
          </ul>
        </p>
      </div>
    </div>
    <!-- End Commands Reminder -->
    <div class="col-xs-10">
      <iframe style="width:100%; height:1000px;" src="https://${subdomain}.craftassist.io/turk.html?turk_experiment_id=${batch}&mephisto_agent_id=${mephisto_agent_id}&turk_worker_id=${provider_worker_id}"></iframe>
    </div>
  </div>
</section>

<section class="container" style="margin-bottom: 20px">
  <fieldset>
    <div class="input-group center">
      <label>Please rate the clarity and usability of this HIT</label>
      <select class="form-control" name="usability-rating" onchange="usabilityRated()">
        <option selected="selected" value="">(select one)</option>
        <option value="7">7 - Perfect</option>
        <option value="6">6 - Very good</option>
        <option value="5">5 - Decent</option>
        <option value="4">4 - OK</option>
        <option value="3">3 - Poor</option>
        <option value="2">2 - Very Poor</option>
        <option value="1">1 - Unusable</option>
      </select>
      <input type="hidden" id="clickedElements" name="clickedElements" value="0">
      <input type="hidden" id="instructionsReadTime" name="instructionsReadTime" value="0">
      <input type="hidden" id="preInteractTime" name="preInteractTime" value="0">
      <input type="hidden" id="interactTime" name="interactTime" value="0">
    </div>
  </fieldset>
</section>


<script>
  var timerStopped = false;
  var ratingComplete = false;

  var clickedElements = new Array();
  function recordClick(ele) {
    clickedElements.push({id: ele, timestamp: Date.now()});
    document.getElementById("clickedElements").value = clickedElements;
    console.log("Clicked elements array: " + JSON.stringify(clickedElements));
  }

  function checkSubmitDisplay() {
    if (ratingComplete && timerStopped) {  //Only display the submit button if the worker has interacted with the dashboard and rated usability
      document.getElementsByClassName("btn-default")[0].classList.remove("hidden");
      window.scrollTo(0,document.body.scrollHeight);
    }
  }

  function usabilityRated() {
    ratingComplete = true;
    recordClick("usability-rated");
    checkSubmitDisplay();
  }

  const start = Date.now();
  var readTimestamp = start;
  var startButtonTimestamp = start;
  var stopButtonTimestamp = start;

  function recordReadTime() {
    recordClick("instructions-popup-close");
    readTimestamp = Date.now();
    readTime = Math.floor((readTimestamp - start)/1000);
    document.getElementById("instructionsReadTime").value = readTime;

    //Also take this opportunity to do some other housekeeping that doesn't work well with MTurk...
    document.getElementsByClassName("btn-default")[0].classList.add("hidden");
    window.addEventListener("message", (event) => {
      data = JSON.parse(event.data);
      console.log(data);
      if (data.msg === "timerON") recordStartButtonTime();
      else if (data.msg === "timerOFF") recordInteractTime();
      else recordClick(data.msg);
      // In the future can also use this to record interaction quality scores
      checkSubmitDisplay();
    }, false);
  }

  // Can probably deprecate these functions in favor of doing everything through recordClick
  function recordStartButtonTime() {
    startButtonTimestamp = Date.now();
    preInteractTime = Math.floor((startButtonTimestamp - readTimestamp)/1000);
    document.getElementById("preInteractTime").value = preInteractTime;
    recordClick("start-btn");
  }
  function recordInteractTime() {
    timerStopped = true;
    stopButtonTimestamp = Date.now();
    interactTime = Math.floor((stopButtonTimestamp - startButtonTimestamp)/1000);
    document.getElementById("interactTime").value = interactTime;
    recordClick("end-btn");
  }

  function showHideInstructions() {
    document.getElementsByClassName("collapse")[0].toggle();
    recordClick("toggle-instructions");
  }
  
  $(function () {
    modal_body = $("#modal");
    $("#instructions").clone().appendTo(modal_body);
    $(".modal").modal("show");
  });

  var page = 1;
  function incrementPage(val) {
    page += val;
    if (page < 1) page = 1;
    if (page > 6) page = 6;
    applyPagination(page);
  }

  function applyPagination(pg) {
    const pageID = "page-" + pg;
    recordClick(pageID);
    page = pg;

    if (pg === 1) document.getElementById("previous").classList.add("disabled");
    else document.getElementById("previous").classList.remove("disabled");
    if (pg === 6) {
      document.getElementById("next").classList.add("disabled");
      document.getElementById("close-instructions-btn").style.display = "block";
    }
    else document.getElementById("next").classList.remove("disabled");
    let pgID, btnID;
    for (let i=1; i<=6; i++) {
      pgID = "instructions-page-" + i;
      btnID = "pg" + i;
      if (i === pg) {
        document.getElementById(btnID).classList.add("active");
        document.getElementById(pgID).classList.add("in");
      }
      else {
        document.getElementById(btnID).classList.remove("active");
        document.getElementById(pgID).classList.remove("in");
      }
    }
  }

</script>

<style type="text/css">
  fieldset {
    padding: 10px;
    background: #fbfbfb;
    border-radius: 5px;
    margin-bottom: 5px;
  }

  #instructions {
    padding: 10px;
  }

  .previews {
    width: 33%;
    height: 180px;
  }

  .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

  .input_location {
    background-color: blanchedalmond;
    padding: 10px;
  }
</style>
