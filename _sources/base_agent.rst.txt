
The abstract droidlet agent consists of four major components: a `memory </../../blob/master/docs/source/memory.md>`_ system, a `controller </../../blob/master/docs/source/controller.md>`_\ , a set of `perceptual modules </../../blob/master/docs/source/perception.md>`_\ , and a set of low level `tasks </../../blob/master/docs/source/tasks.md>`_.  In a nutshell, 


* the memory system acts as a nexus of information for all the other systems, 
* the controller places tasks on a stack, based on the state of the memory system, 
* the perceptual modules process information from the outside world and store it in the memory system, 
* and the low-level tasks effect changes in the outside world. 

The components in this library can be used separately from the "complete" agent; or can be replaced or combined as a user sees fit.
The high level control loop of the agent is cartooned in `here </../../blob/master/base_agent/core.py>`_ and shown below:

.. code-block::

   while forever:
        run perception and update memory
        maybe place tasks on the stack, based on memory
        step topmost task on Task Stack

Controller
==========

Instead of directly affecting the agent's environment, the controller places `Task </../../blob/master/base_agent/task.py>`_ objects on a `Task Stack </../../blob/master/base_agent/sql_memory.py#L555>`_.   In order to choose which to place (if any), it needs to read information about the state of the world from memory.

In addition to the "abstract" droidlet agent, this repo has two "batteries included" agent instantiations, located `here </../../blob/master/locobot/agent>`_ and `here </../../blob/master/craftassist/agent/>`_.  In these (lets call the pair of them "McAgents"), the controller is mediated in part by a Dialogue Manager with an associated Dialogue Stack, which attempt to convert human interactions (dialogue) into specifications of Tasks.  The Dialogue Stack is populated with Dialogue Objects, which carry out chunks of human interaction, for example asking for a clarification about a command.

In the McAgents the Dialogue Manager is in turn powered by a neural semantic parser, which translates natural language into partially specified programs in a DSL decribed `here </../../blob/master/base_agent/documents/Action_Dictionary_Spec.md>`_.  The partially specified programs are then made "executable" (i.e. interpreted into Task Stack manipulations, including adding Tasks) by the Intepreter Dialogue Object.  This object is further broken down into subinterpreters that correspond to subtrees of the logical forms in the DSL, and is described in more detail `here </../../blob/master/docs/source/interpreter.md>`_

The Controller operation in the McAgents can be sketched as:

.. code-block::

   if new command:
        logical_form = semantic_parser.translate(new command)
        interpret(logical_form, agent_memory)
   if TaskStack is empty:
        maybe place default behaviors on the stack

Here "default behaviors" might be running SLAM or other self-supervised exploration.

Memory
======

The `memory system </../../blob/master/docs/source/memory.md>`_ serves as the interface for passing information between the various components of the agent.  It consists of 

**A database**\ , currently implemented in SQL, with an overlayed triplestore.  The entry point to the underlying SQL database is an `AgentMemory </../../blob/master/base_agent/sql_memory.py>`_ object.  The database can be directly queried through SQL; some common queries using triples or that otherwise are messy in raw SQL have been simplified and packaged.   

**MemoryNodes**\ , which are Python wrappers for coherent data.  MemoryNodes collate data about a particular entity or event.  There are MemoryNodes for ReferenceObjects (things that have a location in space), for Tasks, for chats and commands, etc. 

**FILTERS** objects, which connect the AgentMemory and MemoryNodes to the DSL used in the McAgents

Tasks
=====

The `Task </../../blob/master/base_agent/task.py>`_ objects abstract away the difficulties of actually carrying out the tasks, and allow a uniform interface to the controller and memory across different platforms.  

Task objects define a .step() method; on each iteration through the main agent loop, the Task is stepped, and the Task Stack steps its highest priority Task.
The Task objects themselves are *not* generic across agents; and can be heuristic or learned.  In the current droidlet agent controller, they are registered `here </../../blob/master/base_agent/dialogue_objects/interpreter.py#L76>`_\ , for example `here </../../blob/master/craftassist/agent/dialogue_objects/mc_interpreter.py#L78>`_ and `here </../../blob/master/locobot/agent/dialogue_objects/loco_interpreter.py#L64>`_

The `Task Stack </../../blob/master/base_agent/sql_memory.py#L555>`_ is maintained by the Memory system, and provides methods for examining and manipulating Task Objects

Perception
==========

Perceptual modules process information about the agent's environment and write to memory.  Each perceptual module should have a .perceive() method, which is called 
`here </../../blob/master/base_agent/loco_mc_agent.py#L180>`_\ , during the main agent loop.   
